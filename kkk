import asyncio
import subprocess
import re
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from telegram.constants import ParseMode
from telegram.request import HTTPXRequest

# --- THÃ”NG TIN CHIáº¾N LÆ¯á»¢C ---
TOKEN = '8589862869:AAExkuni4vIqw74yL6KWYnm5nvkfJvJNxjA'
BOSS_USER_ID = 7934171537    
API_KEY_LINK4M = "6981ed41aa416431716126eb"
MY_COOKIE = "PHPSESSID=48b49bfe3f518c4b2c3934635788dec2"
THUMB_IMAGE = "https://link4m.com/templates/default/IteckTheme/assets/img/thumb.jpg"

async def is_boss(update: Update):
    return update.effective_user.id == BOSS_USER_ID

def get_all_links_from_web():
    """Truy cáº­p trang quáº£n lÃ½ Ä‘á»ƒ láº¥y láº¡i toÃ n bá»™ link cÅ© trong quÃ¡ khá»©"""
    cmd = [
        'curl', '-s', '-k', '-L',
        '--cookie', MY_COOKIE,
        '-A', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'https://link4m.com/member/links'
    ]
    html = subprocess.run(cmd, capture_output=True, text=True).stdout
    
    # TÃ¬m táº¥t cáº£ cÃ¡c dÃ²ng chá»©a link vÃ  mÃ£ xÃ³a trong báº£ng cá»§a Link4M
    # QuÃ©t Link Gá»‘c, Link RÃºt Gá»n vÃ  Alias
    items = []
    # Regex nÃ y tÃ¬m cáº¥u trÃºc báº£ng: MÃ£ Alias, Link Gá»‘c
    found_aliases = re.findall(r'member/links/delete/([a-zA-Z0-9]+)', html)
    found_origins = re.findall(r'class="text-ellipsis">([^<]+)</td>', html) # Link gá»‘c thÆ°á»ng náº±m trong class nÃ y
    
    for i in range(min(len(found_aliases), len(found_origins))):
        items.append({
            "alias": found_aliases[i],
            "goc": found_origins[i].strip(),
            "rut": f"https://link4m.co/st/{found_aliases[i]}"
        })
    return items

async def scan_all(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Lá»‡nh quÃ©t toÃ n bá»™ link trong quÃ¡ khá»©"""
    if not await is_boss(update): return
    
    status = await context.bot.send_message(chat_id=BOSS_USER_ID, text="ğŸ” **Äang quÃ©t ngÆ°á»£c quÃ¡ khá»© Ä‘á»ƒ tÃ¬m link cÅ©...**")
    
    loop = asyncio.get_event_loop()
    links = await loop.run_in_executor(None, get_all_links_from_web)
    
    if not links:
        await status.edit_text("ğŸ“­ KhÃ´ng tÃ¬m tháº¥y link nÃ o trong kho dá»¯ liá»‡u cá»§a Boss.")
        return

    msg = "ğŸ“‚ **KHO LINK ÄÃƒ Táº O TRONG QUÃ KHá»¨:**\n\n"
    for i, item in enumerate(links[:10], 1): # Hiá»‡n 10 link gáº§n nháº¥t cho Ä‘á»¡ rá»‘i
        msg += f"{i}. ğŸ”— Gá»‘c: `{item['goc'][:25]}...`\n   ğŸš€ RÃºt gá»n: `{item['rut']}`\n   ğŸ—‘ MÃ£ xÃ³a: `{item['alias']}`\n\n"
    
    msg += "ğŸ’¡ *Boss chá»‰ cáº§n copy MÃ£ xÃ³a rá»“i gÃµ /xoa [mÃ£] Ä‘á»ƒ há»§y nhÃ©!*"
    await status.edit_text(msg, parse_mode=ParseMode.MARKDOWN)

async def handle_link(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_boss(update): return
    raw_text = update.message.text.strip()
    if raw_text.startswith('/'): return

    status = await context.bot.send_message(chat_id=BOSS_USER_ID, text="âš¡ **Äang xá»­ lÃ½ link má»›i...**")
    
    # Logic táº¡o link (nhÆ° báº£n trÆ°á»›c nhÆ°ng tá»‘i Æ°u hÆ¡n)
    target_url = f"https://link4m.co/st?api={API_KEY_LINK4M}&url={raw_text}"
    cmd = ['curl', '-s', '-k', '-L', '--cookie', MY_COOKIE, target_url]
    res = subprocess.run(cmd, capture_output=True, text=True).stdout
    
    final_link = next((l for l in re.findall(r'https?://link4m\.[^\s<>"]+', res) if "/st/" in l), None)
    
    if final_link:
        alias = final_link.split('/')[-1]
        msg = f"ğŸ’ **LINK Má»šI ÄÃƒ Sáº´N SÃ€NG**\n\nğŸ”— Gá»‘c: `{raw_text}`\nğŸš€ RÃºt gá»n: `{final_link}`\nğŸ—‘ MÃ£ xÃ³a: `{alias}`"
        await context.bot.send_photo(chat_id=BOSS_USER_ID, photo=THUMB_IMAGE, caption=msg, parse_mode=ParseMode.MARKDOWN)
        await status.delete()
    else:
        await status.edit_text("âŒ Lá»—i táº¡o link. Check láº¡i API/Cookie!")

async def delete_links(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_boss(update): return
    for code in context.args:
        subprocess.run(['curl', '-s', '-X', 'POST', '--cookie', MY_COOKIE, f"https://link4m.com/member/links/delete/{code}"])
    await context.bot.send_message(chat_id=BOSS_USER_ID, text=f"ğŸ—‘ ÄÃ£ há»§y sáº¡ch cÃ¡c link Boss yÃªu cáº§u!")

if __name__ == '__main__':
    t_request = HTTPXRequest(connect_timeout=60, read_timeout=60)
    app = Application.builder().token(TOKEN).request(t_request).build()
    
    app.add_handler(CommandHandler("quatatca", scan_all))
    app.add_handler(CommandHandler("xoa", delete_links))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_link))
    
    print("Há»‡ thá»‘ng 'QuÃ©t ngÆ°á»£c quÃ¡ khá»©' Ä‘ang cháº¡y...")
    app.run_polling(drop_pending_updates=True)
